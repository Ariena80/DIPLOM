<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/account-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/flexbox.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='style/icon.ico') }}" type="image/x-icon" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .content-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-section, .form-container, .requests-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .profile-section {
            flex: 1;
        }

        .form-container {
            flex: 2;
        }

        .requests-container {
            flex: 2;
            max-height: 600px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input[type="text"],
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .radio-group {
            display: flex;
            gap: 15px;
        }

        .radio-group input {
            margin-right: 5px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        button:hover {
            background-color: #45a049;
        }

        .request-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
            transition: transform 0.2s;
        }

        .request-item:hover {
            transform: scale(1.02);
        }

        .request-item h3 {
            margin-top: 0;
            font-size: 18px;
            color: #333;
        }

        .request-item p {
            margin: 5px 0;
            font-size: 14px;
        }

        .status-pending {
            color: orange;
        }

        .status-approved {
            color: green;
        }

        .status-rejected {
            color: red;
        }

        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 10px;
            position: fixed;
            width: 100%;
            bottom: 0;
        }

        .profile-info-row {
            margin-bottom: 10px;
        }

        .profile-info-item {
            margin-bottom: 10px;
        }

        .profile-info-item label {
            display: inline-block;
            width: 80px;
            font-weight: bold;
        }

        .profile-info-item p {
            display: inline-block;
            margin: 0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            overflow: auto;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }

        .delete-team-form {
            margin-top: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .delete-team-form h2 {
            margin-top: 0;
        }

        .delete-team-form select, .delete-team-form button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
        }

        .order-template {
            display: none;
            margin-top: 20px;
        }

        .order-template textarea {
            width: 100%;
            height: 200px;
        }
    </style>
</head>
<body>
    <header>
        <img src="{{ url_for('static', filename='style/logotip.png') }}" alt="Логотип" height="100%" width="4%">
        <nav class="navigation">
            <a href="{{ url_for('home') }}" class="news" data-text="Новости"></a>
            <a href="{{ url_for('team') }}" class="team" data-text="Команды"></a>
            <a href="{{ url_for('media') }}" class="media" data-text="Медиа"></a>
            <a href="{{ url_for('measure') }}" class="iconMeasure" data-text="Мероприятия"></a>
            <a href="{{ url_for('contact') }}" class="contact" data-text="О нас"></a>
            <a href="{{ url_for('login') }}" class="account-link" data-text="Профиль"></a>
        </nav>
    </header>
    <div class="main-container">
        <div class="content-container">
            <div class="profile-section">
                <h2>Мой профиль</h2>
                <div class="profile-picture">
                    <img src="{{ url_for('static', filename='style/icon-placeholder.png') }}" alt="Профиль" id="previewImage">
                    <div class="profile-picture-actions">
                        <button onclick="document.getElementById('profilePictureInput').click()">Загрузить фото</button>
                        <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
                    </div>
                </div>
                <div class="profile-info">
                    <div class="profile-info-row">
                        <div class="profile-info-item">
                            <label>Фамилия:</label>
                            <p id="surname"></p>
                        </div>
                        <div class="profile-info-item">
                            <label>Имя:</label>
                            <p id="first_name"></p>
                        </div>
                        <div class="profile-info-item">
                            <label>Отчество:</label>
                            <p id="middle_name"></p>
                        </div>
                    </div>
                    <div class="profile-info-row">
                        <div class="profile-info-item">
                            <label>Должность:</label>
                            <p id="position"></p>
                        </div>
                    </div>
                    <button id="logoutButton" class="logoutButton">Выйти</button>
                </div>
            </div>
            <div class="sidebar">
                <button data-action="showPhysOrgForm">Добавить физорга</button>
                <button data-action="showNewsForm">Добавить новость</button>
                <button data-action="showEventForm">Добавить мероприятие</button>
                <button data-action="showMediaForm">Добавить фото</button>
                <button data-action="showAwardsForm">Добавить награду</button>
                <button data-action="showEditStatisticForm">Результаты</button>
                <button data-action="showApproveRequests">Одобрить заявку</button>
                <button data-action="showTeamForm">Удалить команду</button>
            </div>
            <div id="uploadModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeUploadModal()">&times;</span>
                    <h2>Загрузить фото</h2>
                    <canvas id="cropCanvas"></canvas>
                    <input type="range" id="zoomRange" min="1" max="3" step="0.1" value="1">
                    <button id="savePic">Сохранить</button>
                </div>
            </div>
            <div id="profileForm" class="content">
                <h2>Мой профиль</h2>
                <div class="profile-section">
                    <div class="profile-picture">
                        <img src="{{ url_for('static', filename='style/icon-placeholder.png') }}" alt="Предварительный просмотр" id="previewImage">
                        <form action="/api/upload_profile_picture" method="POST" enctype="multipart/form-data">
                            <input type="file" name="profile_picture" accept="image/*">
                            <button type="submit">Загрузить фото профиля</button>
                        </form>
                    </div>
                    <div class="profile-info">
                        <div class="form-group">
                            <div class="info-row">
                                <div>
                                    <h3>Фамилия</h3>
                                    <label id="surname">Фамилия:</label>
                                    <p id="surname"></p>
                                </div>
                                <div>
                                    <h3>Имя</h3>
                                    <label id="first_name">Имя:</label>
                                    <p id="first_name"></p>
                                </div>
                                <div>
                                    <h3>Отчество</h3>
                                    <label id="middle_name">Отчество:</label>
                                    <p id="middle_name"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="mediaForm" class="content" style="display: none;">
                <h2>Добавление фото</h2>
                <form action="upload.php" method="POST" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="title">Заголовок:</label>
                        <input type="text" id="title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="sport_type">Выбор вида спорта:</label>
                        <select id="sport_type" name="sport_type" required>
                            <!-- Опции будут загружены динамически -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="media_files">Файлы:</label>
                        <input type="file" id="media_files" name="media_files[]" multiple required>
                    </div>
                    <div class="form-group">
                        <input type="submit" value="Загрузить">
                    </div>
                </form>
            </div>
            <div id="teamForm" class="content delete-team-form" style="display: none;">
                <h2>Удалить команду</h2>
                <div class="form-group">
                    <label for="delete_team">Выберите команду для удаления:</label>
                    <select id="delete_team" name="delete_team">
                        <!-- Опции будут загружены динамически -->
                    </select>
                    <button type="button" onclick="deleteTeam()">Удалить команду</button>
                </div>
            </div>
            <div id="physOrgForm" class="content" style="display: none;">
                <h2>Добавление физорга</h2>
                <form id="physOrgForm" action="/api/add_physorg" method="POST">
                    <div class="form-group">
                        <label for="surname">Фамилия:</label>
                        <input type="text" id="surname" name="surname" required>
                    </div>
                    <div class="form-group">
                        <label for="name">Имя:</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="patronymic">Отчество:</label>
                        <input type="text" id="patronymic" name="patronymic">
                    </div>
                    <div class="form-group">
                        <label for="gender">Пол:</label>
                        <div class="radio-group">
                            <input type="radio" id="male" name="gender" value="male" required>
                            <label for="male">Мужской</label>
                            <input type="radio" id="female" name="gender" value="female" required>
                            <label for="female">Женский</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="course">Курс:</label>
                        <select id="course" name="course" required>
                            <option value="1">1 курс</option>
                            <option value="2">2 курс</option>
                            <option value="3">3 курс</option>
                            <option value="4">4 курс</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="group">Группа:</label>
                        <select id="group" name="group" required>
                            <!-- Группы будут загружены динамически -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="login">Логин:</label>
                        <input type="text" id="login" name="login" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Пароль:</label>
                        <input type="text" id="password" name="password" required placeholder="Введите или сгенерируйте пароль">
                        <button type="button" id="generatePasswordButton" onclick="generatePassword()">Сгенерировать пароль</button>
                    </div>
                    <div class="form-group">
                        <input type="submit" value="Добавить физорга">
                    </div>
                </form>
                <div class="form-group">
                    <label for="delete_physorg">Удалить физорга:</label>
                    <select id="delete_physorg" name="delete_physorg">
                        <!-- Опции будут загружены динамически -->
                    </select>
                    <button type="button" onclick="deletePhysOrg()">Удалить физорга</button>
                </div>
            </div>
            <div id="eventForm" class="content" style="display: none;">
                <h2>Добавление мероприятия</h2>
                <form id="addEventForm" action="/api/add_event" method="POST">
                    <div class="form-group">
                        <label for="event_type">Тип мероприятия:</label>
                        <select id="event_type" name="event_type" required>
                            <!-- Опции будут загружены динамически -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sport_type">Вид спорта:</label>
                        <select id="sport_type" name="sport_type" required>
                            <!-- Опции будут загружены динамически -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="event_name">Название мероприятия:</label>
                        <input type="text" id="event_name" name="event_name" required>
                    </div>
                    <div class="date-time-container">
                        <div class="form-group">
                            <label for="event_date">Дата мероприятия:</label>
                            <input type="date" id="event_date" name="event_date" required>
                        </div>
                        <div class="form-group">
                            <label for="event_time">Время мероприятия:</label>
                            <input type="time" id="event_time" name="event_time" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="location">Место проведения:</label>
                        <select id="location" name="location" required>
                            <!-- Опции будут загружены динамически -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="description">Описание:</label>
                        <textarea id="description" name="description" required></textarea>
                    </div>
                    <div class="form-group">
                        <input type="submit" value="Добавить мероприятие">
                    </div>
                </form>
            </div>
            <div id="editStatisticForm" class="content" style="display: none;">
                <h2>Результаты</h2>
                <form id="editStatistic" onsubmit="event.preventDefault(); submitStatistic();">
                    <div class="form-group">
                        <label for="event_select">Мероприятие:</label>
                        <select id="event_select" name="event_select" required>
                            <!-- Опции будут загружены динамически -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>1 место:</label>
                        <select id="first_place" name="first_place" required>
                            <!-- Опции будут загружены динамически -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>2 место:</label>
                        <select id="second_place" name="second_place" required>
                            <!-- Опции будут загружены динамически -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>3 место:</label>
                        <select id="third_place" name="third_place" required>
                            <!-- Опции будут загружены динамически -->
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="submit" value="Сохранить изменения">
                    </div>
                </form>
            </div>
            <div id="newsForm" class="content" style="display: none;">
                <h2>Добавление новостей</h2>
                <form id="addNewsForm" action="/api/add_news" method="POST" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="title">Заголовок:</label>
                        <input type="text" id="title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="content">Содержание:</label>
                        <textarea id="content" name="content" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="image">Фотография:</label>
                        <input type="file" id="image" name="image" accept="image/*">
                    </div>
                    <div class="form-group">
                        <button type="submit">Опубликовать новость</button>
                    </div>
                </form>
            </div>
            <div id="awardsForm" class="content" style="display: none;">
                <h2>Добавление наград</h2>
                <form id="addAwardForm" action="add_award.php" method="POST" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="award_name">Название награды:</label>
                        <input type="text" id="award_name" name="award_name" required>
                    </div>
                    <div class="form-group">
                        <label for="recipient">Получатель награды:</label>
                        <input type="text" id="recipient" name="recipient" required>
                    </div>
                    <div class="form-group">
                        <label for="award_image">Фото:</label>
                        <input type="file" id="award_image" name="award_image" accept="image/*" required>
                    </div>
                    <div class="form-group">
                        <input type="submit" value="Добавить награду">
                    </div>
                </form>
                <div class="form-group">
                    <label for="delete_award">Удалить награду:</label>
                    <select id="delete_award" name="delete_award">
                        <!-- Опции будут загружены динамически -->
                    </select>
                    <button type="button" onclick="deleteAward()">Удалить награду</button>
                </div>
            </div>
            <div id="approveRequestsForm" class="content" style="display: none;">
                <h2>Одобрение заявок</h2>
                <div class="requests-container">
                    <h2>Список заявок</h2>
                    <div id="requestsList">
                        <!-- Заявки будут загружены динамически -->
                    </div>
                </div>
                <div class="form-group">
                    <button type="button" onclick="generateOrder()">Составить распоряжение</button>
                </div>
                <div class="order-template" id="orderTemplate">
                    <h3>Распоряжение</h3>
                    <textarea id="orderText" rows="10" cols="50" readonly></textarea>
                    <button onclick="downloadOrder()">Скачать распоряжение</button>
                </div>
            </div>
        </div>
    </div>
    <footer>
        <p>© Все права защищены Arieshka, 2025.</p>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetchUserData();
            setupSidebarButtons();
            setupLogoutButton();
            setupFormHandlers();
            fetchNews();
            setupProfilePictureUpload();
            setupInactivityTimer();
            fetchGroups();
            fetchSportTypes();
            fetchGenders();
            fetchEventTypes();
            fetchLocations();
            fetchAwards();
            fetchCommands();
            fetchPhysOrgs();
        });

        function fetchUserData() {
            fetch('/api/user_data')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('surname').textContent = data.surname;
                    document.getElementById('first_name').textContent = data.name;
                    document.getElementById('middle_name').textContent = data.patronymic;
                    const roleId = data.role;
                    let position = '';
                    if (roleId === 1) {
                        position = 'Администратор';
                    } else if (roleId === 2) {
                        position = 'Физорг';
                    }
                    document.getElementById('position').textContent = position;
                })
                .catch(error => console.error('Error fetching user data:', error));
        }

        function setupSidebarButtons() {
            document.querySelectorAll('.sidebar button').forEach(button => {
                button.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    let formId;
                    if (action === 'showTeamForm') formId = 'teamForm';
                    else if (action === 'showPhysOrgForm') formId = 'physOrgForm';
                    else if (action === 'showMediaForm') formId = 'mediaForm';
                    else if (action === 'showEventForm') formId = 'eventForm';
                    else if (action === 'showEditStatisticForm') formId = 'editStatisticForm';
                    else if (action === 'showNewsForm') formId = 'newsForm';
                    else if (action === 'showAwardsForm') formId = 'awardsForm';
                    else if (action === 'showApproveRequests') {
                        formId = 'approveRequestsForm';
                        fetchRequests();
                    }
                    showForm(formId);
                });
            });
        }

        function showForm(formId) {
            const forms = document.querySelectorAll('.content');
            forms.forEach(form => {
                form.style.display = 'none';
            });
            const formToShow = document.getElementById(formId);
            if (formToShow) {
                formToShow.style.display = 'block';
                if (formId === 'editStatisticForm') {
                    fetchEvents();
                    fetchTeams();
                }
            }
        }

        function setupLogoutButton() {
            document.getElementById('logoutButton').addEventListener('click', function() {
                fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = 'login.html';
                    } else {
                        alert('Ошибка при выходе');
                    }
                })
                .catch(error => console.error('Error logging out:', error));
            });
        }

        function setupFormHandlers() {
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', function(event) {
                    event.preventDefault();
                    const submitButton = form.querySelector('input[type="submit"]');
                    submitButton.disabled = true;
                    const formData = new FormData(form);
                    const action = form.getAttribute('action');
                    fetch(action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Данные успешно сохранены');
                            form.reset();
                        } else {
                            alert('Ошибка при сохранении данных: ' + data.message);
                        }
                    })
                    .catch(error => console.error('Ошибка:', error))
                    .finally(() => {
                        submitButton.disabled = false;
                    });
                });
            });
        }

        function fetchNews() {
            fetch('/api/get_news')
                .then(response => response.json())
                .then(data => {
                    const newsContainer = document.getElementById('news-container');
                    newsContainer.innerHTML = '';
                    data.news.forEach(newsItem => {
                        const newsElement = document.createElement('div');
                        newsElement.className = 'news-item';
                        newsElement.innerHTML = `
                            <h3>${newsItem.title}</h3>
                            <p>${newsItem.description}</p>
                            <p>Дата: ${new Date(newsItem.date).toLocaleDateString()}</p>
                            ${newsItem.imageURL ? `<img src="/static/uploads/${newsItem.imageURL.split('/').pop()}" alt="Изображение новости" style="max-width: 100%; height: auto;">` : ''}
                        `;
                        newsContainer.appendChild(newsElement);
                    });
                })
                .catch(error => console.error('Ошибка при получении новостей:', error));
        }

        function fetchEvents() {
            fetch('/api/get_events')
                .then(response => response.json())
                .then(data => {
                    const eventSelect = document.getElementById('event_select');
                    eventSelect.innerHTML = '';
                    data.events.forEach(event => {
                        const option = document.createElement('option');
                        option.value = event.id;
                        option.textContent = event.name;
                        eventSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching events:', error));
        }

        function fetchTeams() {
            fetch('/api/get_commands')
                .then(response => response.json())
                .then(data => {
                    const firstPlaceSelect = document.getElementById('first_place');
                    const secondPlaceSelect = document.getElementById('second_place');
                    const thirdPlaceSelect = document.getElementById('third_place');
                    [firstPlaceSelect, secondPlaceSelect, thirdPlaceSelect].forEach(select => {
                        select.innerHTML = '';
                        data.commands.forEach(command => {
                            const option = document.createElement('option');
                            option.value = command.id;
                            option.textContent = command.name;
                            select.appendChild(option);
                        });
                    });
                })
                .catch(error => console.error('Error fetching teams:', error));
        }

        function submitStatistic() {
            const formData = {
                event_id: document.getElementById('event_select').value,
                first_place: document.getElementById('first_place').value,
                second_place: document.getElementById('second_place').value,
                third_place: document.getElementById('third_place').value
            };

            fetch('/api/update_statistics', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Результаты успешно обновлены');
                } else {
                    alert('Ошибка при обновлении результатов: ' + data.message);
                }
            })
            .catch(error => console.error('Ошибка:', error));
        }

        function setupProfilePictureUpload() {
            document.getElementById('profilePictureInput').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = function() {
                            const cropCanvas = document.getElementById('cropCanvas');
                            const ctx = cropCanvas.getContext('2d');
                            cropCanvas.width = img.width;
                            cropCanvas.height = img.height;
                            ctx.drawImage(img, 0, 0, img.width, img.height);
                            document.getElementById('uploadModal').style.display = 'block';
                        }
                    }
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('savePic').addEventListener('click', function() {
                const fileInput = document.getElementById('profilePictureInput');
                const formData = new FormData();
                if (fileInput.files.length > 0) {
                    formData.append('profile_picture', fileInput.files[0]);
                    fetch('/api/profile_picture', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Фото профиля успешно загружено');
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                document.getElementById('previewImage').src = e.target.result;
                                localStorage.setItem('profileImage', e.target.result);
                            }
                            reader.readAsDataURL(fileInput.files[0]);
                            closeUploadModal();
                        } else {
                            alert('Ошибка при загрузке фото: ' + data.error);
                        }
                    })
                    .catch(error => console.error('Ошибка:', error));
                } else {
                    alert('Пожалуйста, выберите файл для загрузки.');
                }
            });

            const savedImage = localStorage.getItem('profileImage');
            if (savedImage) {
                document.getElementById('previewImage').src = savedImage;
            }
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
        }

        function setupInactivityTimer() {
            const inactivityDuration = 3600000;
            let inactivityTimeout;

            function startInactivityTimer() {
                inactivityTimeout = setTimeout(logoutDueToInactivity, inactivityDuration);
            }

            function resetInactivityTimer() {
                clearTimeout(inactivityTimeout);
                startInactivityTimer();
            }

            function logoutDueToInactivity() {
                fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = 'login.html';
                    } else {
                        alert('Ошибка при автоматическом выходе');
                    }
                })
                .catch(error => console.error('Error logging out due to inactivity:', error));
            }

            document.addEventListener('mousemove', resetInactivityTimer);
            document.addEventListener('keypress', resetInactivityTimer);
            document.addEventListener('click', resetInactivityTimer);

            startInactivityTimer();
        }

        function generatePassword() {
            const length = 12;
            const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+~`|}{[]:;?><,./-=";
            let password = "";
            for (let i = 0, n = charset.length; i < length; ++i) {
                password += charset.charAt(Math.floor(Math.random() * n));
            }
            document.getElementById('password').value = password;
        }

        function fetchGroups() {
            fetch('/api/get_groups')
                .then(response => response.json())
                .then(data => {
                    const groupSelects = document.querySelectorAll('#group');
                    groupSelects.forEach(select => {
                        select.innerHTML = '';
                        data.groups.forEach(group => {
                            const option = document.createElement('option');
                            option.value = group.name;
                            option.textContent = group.name;
                            select.appendChild(option);
                        });
                    });
                })
                .catch(error => console.error('Error fetching groups:', error));
        }

        function fetchSportTypes() {
            fetch('/api/get_sport_types')
                .then(response => response.json())
                .then(data => {
                    const sportTypeSelects = document.querySelectorAll('#sport_type');
                    sportTypeSelects.forEach(select => {
                        select.innerHTML = '';
                        data.sport_types.forEach(sportType => {
                            const option = document.createElement('option');
                            option.value = sportType.id;
                            option.textContent = sportType.name;
                            select.appendChild(option);
                        });
                    });
                })
                .catch(error => console.error('Error fetching sport types:', error));
        }

        function fetchGenders() {
            fetch('/api/get_genders')
                .then(response => response.json())
                .then(data => {
                    const genderRadioGroups = document.querySelectorAll('#gender');
                    genderRadioGroups.forEach(group => {
                        group.innerHTML = '';
                        data.genders.forEach(gender => {
                            const radioInput = document.createElement('input');
                            radioInput.type = 'radio';
                            radioInput.id = `gender_${gender.id}`;
                            radioInput.name = 'gender';
                            radioInput.value = gender.id;
                            radioInput.required = true;
                            const label = document.createElement('label');
                            label.setAttribute('for', `gender_${gender.id}`);
                            label.textContent = gender.name;
                            group.appendChild(radioInput);
                            group.appendChild(label);
                            group.appendChild(document.createElement('br'));
                        });
                    });
                })
                .catch(error => console.error('Error fetching genders:', error));
        }

        function fetchEventTypes() {
            fetch('/api/get_event_types')
                .then(response => response.json())
                .then(data => {
                    const eventTypeSelect = document.getElementById('event_type');
                    if (eventTypeSelect) {
                        eventTypeSelect.innerHTML = '';
                        data.event_types.forEach(eventType => {
                            const option = document.createElement('option');
                            option.value = eventType.id;
                            option.textContent = eventType.name;
                            eventTypeSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error fetching event types:', error));
        }

        function fetchLocations() {
            fetch('/api/get_locations')
                .then(response => response.json())
                .then(data => {
                    const locationSelect = document.getElementById('location');
                    if (locationSelect) {
                        locationSelect.innerHTML = '';
                        data.locations.forEach(location => {
                            const option = document.createElement('option');
                            option.value = location.id;
                            option.textContent = location.name;
                            locationSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error fetching locations:', error));
        }

        function fetchAwards() {
            fetch('/api/get_awards')
                .then(response => response.json())
                .then(data => {
                    const deleteAwardSelect = document.getElementById('delete_award');
                    if (deleteAwardSelect) {
                        deleteAwardSelect.innerHTML = '';
                        data.awards.forEach(award => {
                            const option = document.createElement('option');
                            option.value = award.id;
                            option.textContent = award.name;
                            deleteAwardSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error fetching awards:', error));
        }

        function fetchCommands() {
            fetch('/api/get_commands')
                .then(response => response.json())
                .then(data => {
                    const teamSelect = document.getElementById('team_select');
                    const deleteTeamSelect = document.getElementById('delete_team');
                    if (teamSelect) {
                        teamSelect.innerHTML = '';
                        data.commands.forEach(command => {
                            const option = document.createElement('option');
                            option.value = command.id;
                            option.textContent = command.name;
                            teamSelect.appendChild(option);
                        });
                    }
                    if (deleteTeamSelect) {
                        deleteTeamSelect.innerHTML = '';
                        data.commands.forEach(command => {
                            const option = document.createElement('option');
                            option.value = command.id;
                            option.textContent = command.name;
                            deleteTeamSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error fetching commands:', error));
        }

        function fetchPhysOrgs() {
            fetch('/api/get_physorgs')
                .then(response => response.json())
                .then(data => {
                    const deletePhysOrgSelect = document.getElementById('delete_physorg');
                    if (deletePhysOrgSelect) {
                        deletePhysOrgSelect.innerHTML = '';
                        data.physorgs.forEach(physorg => {
                            const option = document.createElement('option');
                            option.value = physorg.id;
                            option.textContent = `${physorg.surname} ${physorg.name} ${physorg.patronymic}`;
                            deletePhysOrgSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error fetching physorgs:', error));
        }


  function fetchRequests() {
    fetch('/api/get_requests')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data); // Отладочное сообщение для проверки данных

            const requestsList = document.getElementById('requestsList');
            requestsList.innerHTML = '';

            if (!data.requests || data.requests.length === 0) {
                requestsList.innerHTML = '<p>Нет доступных заявок</p>';
                return;
            }

            // Сортировка заявок: сначала не одобренные, затем одобренные
            data.requests.sort((a, b) => {
                const statusOrder = { 'pending': 1, 'approved': 2, 'rejected': 3 };
                return statusOrder[a.status] - statusOrder[b.status];
            });

            data.requests.forEach(request => {
                console.log('Request data:', request); // Отладочное сообщение для проверки данных заявки

                const requestElement = document.createElement('div');
                requestElement.className = 'request-item';
                const statusClass = `status-${request.status.toLowerCase()}`;

                // Используйте правильные ключи из ответа сервера
                requestElement.innerHTML = `
                    <h3>Заявка на участие в ${request.event_name || 'Неизвестное мероприятие'}</h3>
                    <p>Название команды: ${request.team_name || 'Не указано'}</p>
                    <p>Вид спорта: ${request.sport_type_name || 'Неизвестный вид спорта'}</p>
                    <p>Пол: ${request.gender === 1 ? 'Мужской' : request.gender === 2 ? 'Женский' : 'Неизвестно'}</p>
                    <p>Статус: <span class="${statusClass}">${getStatusText(request.status)}</span></p>
                    <button onclick="approveRequest(${request.id})">Одобрить</button>
                `;
                requestsList.appendChild(requestElement);
            });
        })
        .catch(error => console.error('Ошибка при получении заявок:', error));
}

function getStatusText(status) {
    const statusMap = {
        'pending': 'В ожидании',
        'approved': 'Подтверждено',
        'rejected': 'Отклонено'
    };
    return statusMap[status.toLowerCase()] || status;
}

function approveRequest(requestId) {
    fetch('/api/approve_request', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id: requestId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Заявка одобрена!');
            fetchRequests();
        } else {
            alert('Произошла ошибка при одобрении заявки.');
        }
    })
    .catch(error => console.error('Ошибка при одобрении заявки:', error));
}

        function generateOrder() {
            const date = new Date().toLocaleDateString();
            const eventDate = document.getElementById('event_date').value;
            const eventName = document.getElementById('event_name').value;
            const year = new Date().getFullYear();

            const orderText = `
Автономное профессиональное образовательное учреждение
Вологодской области
«Вологодский колледж связи и информационных технологий»
**РАСПОРЯЖЕНИЕ**
${date} № ______
г. Вологда
В связи с участием в ${eventName}, проводимого ${eventDate}, среди команд студентов, обучающихся по программам среднего профессионального образования в образовательных организациях Вологодской области в спортивном сезоне ${year} года,
ПРЕДЛАГАЮ:
1. Освободить от учебных занятий ${eventDate} следующих студентов:
 - {ФИО студента 1}, {группа}
 - {ФИО студента 2}, {группа}
 - {ФИО студента 3}, {группа}
 - {ФИО студента 4}, {группа}
2. Студентам, задействованным в мероприятии, заранее получить у преподавателей задание для отработки пропущенного материала.
3. Преподавателям обеспечить сдачу промежуточной аттестации, совпадающей со сроками проведения мероприятия, в иные даты в рабочем порядке.
4. Преподавателю физической культуры {ФИО преподавателя} провести со студентами инструктаж по технике безопасности во время проведения турнира.
5. Заведующим отделением довести распоряжение до кураторов учебных групп и преподавателей.
6. Контроль за исполнением распоряжения возложить на заместителя директора по воспитательной работе {ФИО заместителя}.
Директор: И.В. Дарманская
            `;

            document.getElementById('orderText').value = orderText;
            document.getElementById('orderTemplate').style.display = 'block';
        }

        function downloadOrder() {
            const orderText = document.getElementById('orderText').value;
            const blob = new Blob([orderText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Распоряжение.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
